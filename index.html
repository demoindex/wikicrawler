
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>wikicrawler</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">

<style>
:root{
  --tileSize:clamp(90px,25vw,150px);
  --ratio:1/1;
}

html,body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:Helvetica,Arial,sans-serif;
  height:100%;
  overflow:hidden;
}

.ui{
  position:fixed;
  top:0; left:0; right:0;
  height:44px;
  background:#0a0a0a;
  display:flex;
  gap:8px;
  align-items:center;
  padding:0 12px;
  z-index:10;
}

.title{
  font-family:"Special Elite";
  margin-right:12px;
  opacity:.9;
}

/* BUTTONS */

button{
  background:linear-gradient(#2a2a2a,#151515);
  color:#ccc;
  border:1px solid #000;
  padding:6px 10px;
  font-size:11px;
  cursor:pointer;
  border-radius:4px;
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.08),
    0 1px 2px rgba(0,0,0,.6);
  transition:.15s;
  display:inline-flex;
  align-items:center;
  justify-content:center;
}

.ratioBtn{
  width:44px;          /* <-- forced equal width */
  padding:6px 0;       /* symmetric */
  text-align:center;
}

button:hover{background:linear-gradient(#3a3a3a,#1c1c1c);}
button.active{background:linear-gradient(#eaeaea,#bdbdbd);color:#000;}
button.running{background:linear-gradient(#1e3a1e,#0f220f);color:#6cff6c;}
button.stopped{background:linear-gradient(#3a1e1e,#220f0f);color:#ff6c6c;}

@media (max-width:600px){
  .ui{flex-wrap:wrap;height:auto;padding:6px;}
  button{padding:10px;font-size:14px;}
  .ratioBtn{width:52px;}
  .grid{top:72px;}
}

:fullscreen .ui{display:none;}
:fullscreen .grid{top:0;}

/* GRID */

.grid{
  position:fixed;
  top:44px;
  left:0;right:0;bottom:0;
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(var(--tileSize),1fr));
  gap:1px;
  overflow:hidden;
}

.grid.wide{--ratio:4/1;}
.grid.ultrawide{--ratio:8/1;}
.grid.widescreen{--ratio:16/9;}
.grid.tall{--ratio:1/4;}
.grid.avatar{--ratio:1/1;}
.grid.avatar .tile{border-radius:50%;}

.tile{
  aspect-ratio:var(--ratio);
  background-size:cover;
  background-position:center;
  background-color:#111;
  opacity:0;
  transition:.3s;
  cursor:pointer;
  position:relative;
}

.tile.show{opacity:1;}
.placeholder{background:#1a1a1a!important;}

.info{
  position:absolute;
  inset:0;
  background:linear-gradient(to top,rgba(0,0,0,.8),transparent);
  font-size:10px;
  padding:5px;
  display:flex;
  align-items:flex-end;
  opacity:0;
}

.tile:hover .info{opacity:1;}
@media (hover:none){.info{opacity:.6;}}

</style>
</head>

<body>

<div class="ui">
<div class="title">wikicrawler</div>

<button class="ratioBtn active" data-ratio="square">1:1</button>
<button class="ratioBtn" data-ratio="wide">4:1</button>
<button class="ratioBtn" data-ratio="ultrawide">8:1</button>
<button class="ratioBtn" data-ratio="widescreen">16:9</button>
<button class="ratioBtn" data-ratio="tall">1:4</button>
<button class="ratioBtn" data-ratio="avatar">CIRCLE</button>

<button onclick="toggleFullscreen()">FULL</button>
<button id="startBtn" onclick="start()">START</button>
<button id="stopBtn" class="stopped" onclick="stop()">STOP</button>
</div>

<div id="grid" class="grid"></div>

<script>
const grid=document.getElementById("grid");
let source=null;
let currentMode="square";

const startBtn=document.getElementById("startBtn");
const stopBtn=document.getElementById("stopBtn");

function toggleFullscreen(){
 if(!document.fullscreenElement){
  document.documentElement.requestFullscreen();
 }else{
  document.exitFullscreen();
 }
}

document.querySelectorAll(".ratioBtn").forEach(btn=>{
 btn.onclick=()=>{
  document.querySelectorAll(".ratioBtn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  currentMode=btn.dataset.ratio;
  grid.className="grid "+(currentMode==="square"?"":currentMode);
  ensurePlaceholders();
 };
});

function getRatio(){
 if(currentMode==="avatar") return 1;
 const val=getComputedStyle(grid).getPropertyValue("--ratio").trim();
 const [w,h]=val.split("/").map(Number);
 return w/h;
}

function clean(n){return n.replace(/[\\/:*?"<>|]/g,"_");}

function cropDownload(url,title){
 const img=new Image();
 img.crossOrigin="anonymous";
 img.src=url;

 img.onload=()=>{
  const r=getRatio();
  let sw=img.width,sh=img.height;
  let cw=sw,ch=cw/r;
  if(ch>sh){ch=sh;cw=ch*r;}
  const sx=(sw-cw)/2;
  const sy=(sh-ch)/2;

  const size=1024;
  let outW=size;
  let outH=size/r;

  const c=document.createElement("canvas");
  c.width=outW;c.height=outH;
  const ctx=c.getContext("2d");

  if(currentMode==="avatar"){
   ctx.beginPath();
   ctx.arc(outW/2,outH/2,outW/2,0,Math.PI*2);
   ctx.clip();
  }

  ctx.drawImage(img,sx,sy,cw,ch,0,0,outW,outH);

  const a=document.createElement("a");
  a.download=clean(title)+".jpg";
  a.href=c.toDataURL("image/jpeg",0.92);
  a.click();
 };
}

function start(){
 if(source) return;
 source=new EventSource("https://stream.wikimedia.org/v2/stream/recentchange");
 source.onmessage=e=>{
  const d=JSON.parse(e.data);
  if(d.type==="edit" && d.namespace===0) addTile(d);
 };
 startBtn.classList.add("running");
 stopBtn.classList.remove("stopped");
}

function stop(){
 if(source){source.close();source=null;}
 startBtn.classList.remove("running");
 stopBtn.classList.add("stopped");
}

function ensurePlaceholders(){
 const tileW=150;
 const ratio=getRatio();
 const tileH=tileW/ratio;
 const gridHeight=grid.clientHeight||(window.innerHeight-44);

 const cols=Math.ceil(window.innerWidth/tileW);
 const rows=Math.ceil(gridHeight/tileH);
 const needed=cols*rows;

 const real=[...grid.children].filter(t=>!t.classList.contains("placeholder"));
 const placeholders=[...grid.children].filter(t=>t.classList.contains("placeholder"));

 const totalNeeded=Math.max(0,needed-real.length);

 if(placeholders.length<totalNeeded){
  for(let i=0;i<totalNeeded-placeholders.length;i++){
   const t=document.createElement("div");
   t.className="tile show placeholder";
   grid.appendChild(t);
  }
 }

 if(placeholders.length>totalNeeded){
  let remove=placeholders.length-totalNeeded;
  placeholders.reverse().forEach(p=>{
   if(remove>0){p.remove();remove--;}
  });
 }
}

window.addEventListener("resize",ensurePlaceholders);

async function addTile(edit){
 const title=edit.title;
 const lang=edit.wiki.replace("wiki","");
 const url=`https://${lang}.wikipedia.org/wiki/${encodeURIComponent(title)}`;

 try{
  const r=await fetch(`https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`);
  const d=await r.json();
  if(!d.thumbnail) return;

  const thumb=d.thumbnail.source;
  const full=d.originalimage?.source||thumb;

  const img=new Image();
  img.src=thumb;

  img.onload=()=>{
   const tile=document.createElement("div");
   tile.className="tile";
   tile.style.backgroundImage=`url(${thumb})`;

   tile.onclick=(e)=>{
    if(e.altKey){
     e.preventDefault();
     cropDownload(full,title);
    }else{
     window.open(url,"_blank");
    }
   };

   tile.innerHTML=`<div class="info">${title}</div>`;
   grid.prepend(tile);
   requestAnimationFrame(()=>tile.classList.add("show"));

   const ph=[...grid.children].find(t=>t.classList.contains("placeholder"));
   if(ph) ph.remove();
   ensurePlaceholders();
  };

 }catch{}
}

ensurePlaceholders();
start();
</script>
</body>
</html>
